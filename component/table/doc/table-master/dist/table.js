!function(t,a){"function"==typeof define&&define.amd?define(["$","handlebars","paging","query","dialog"],a):t.Table=a($,Handlebars,Paging,Query,Dialog)}(this,function(t,a,e,i,s){function r(a,e,i,s,r,n){this.search=r,this.table=a,this.page=i,this.temp=e,this.template=null,this.pageData=null,this.ajaxurl=a.attr("ajaxurl"),this.ajaxDeleteItemUrl=a.attr("data-ajax-deleteitem-url"),this._total=0,this.pageSize=i.attr("pagesize")||10,this.callback=n,this.param=t.extend(s,{})}return a.registerHelper("equalsten",function(t,a){return t%10==0&&0!=t?a.fn(this):a.inverse(this)}),a.registerHelper("equals",function(t,a,e){return t==a?e.fn(this):e.inverse(this)}),a.registerHelper("indexOf",function(t,a,e){for(var i=!1,s=0,r=a.length;r>s;s++)a[s]==t&&(i=!0);return i?e.fn(this):e.inverse(this)}),a.registerHelper("formatMoney",function(a){var e=a.split("-");return e.length>1?formatAmount.doFormat(t.trim(e[0]))+" - "+formatAmount.doFormat(t.trim(e[1])):formatAmount.doFormat(t.trim(e[0]))}),a.registerHelper("addOne",function(t){return parseInt(t)+1||1}),r.prototype={init:function(e){var s=this.temp.html();this.template=a.compile(s),this.settings=t.extend({type:"post",hash:!0},e),this.currentPage=this.settings.hash?parseInt(i.getQuery("page","#")||1):1,this.search&&(this.param=t.extend(this.param,this.getParam(this.search.closest(".form"))),this.bindSearch()),this.settings.hash&&this.bindHash(),this.bind();var r=this;r.event()},event:function(){var a=this;t(this.table).bind("reload",function(){a.bind()}),this.table.delegate("tr","click",function(){t(this).attr("href")&&!t(this).hasClass("dialog")&&(location.href=t(this).attr("href"))}),this.table.delegate(".js-ajax","click",function(){if(t(this).attr("href")){var e=t(this).attr("href"),i=t(this).attr("js-ajax-param")||{};if(t(this).attr("confirm-msg"))t.confirm(t(this).attr("confirm-msg"),[{yes:"确定"},{no:"取消"}],function(s){var r=this;if("yes"==s){var n={url:e,type:"POST",data:i,dataType:"json"};t.ajax(n).done(function(e){e.status?(r.hide(),a.bind()):t.alert(e.msg)})}else r.hide()});else{var s={url:e,type:"POST",data:i,dataType:"json"};t.ajax(s).done(function(e){e.status?a.bind():t.alert(e.msg)})}}return!1}),t(this.table).on("click",".js-delegate-delete",function(e){var i=t(this).attr("href"),s=t(this).attr("js-ajax-param")||{},r=t(this);return t.confirm("是否确认删除该记录？",[{yes:"确定"},{no:"取消"}],function(n){var h=this;if("yes"==n){var o={url:i,type:"POST",data:s,dataType:"json"};t.ajax(o).done(function(i){i.status?(h.hide(),setTimeout(function(){0==r.closest("tr").siblings("tr").size()&&a.currentPage>1?(a.currentPage--,a.gosearch(a.currentPage)):(a.gosearch(a.currentPage),a.bind()),t(e.target).closest("tr").remove()},500)):t.alert(i.msg)})}else h.hide()}),!1}),this.table.delegate("a:not(.js-ajax,.js-delegate-delete)","click",function(a){var e=t(this).attr("href");""!=e&&"javascript:void(0)"!=e&&"javascript:;"!=e&&"undefined"!=typeof e&&(e+=location.hash,location.href=e,a.preventDefault())}),1==a.settings.hash&&t(window).on("hashchange",function(){a.bindHash(),a.bind()})},bindSearch:function(){var t=this;this.search.click(function(){return t.gosearch(),!1})},bindHash:function(){var a=i.getHash();this.param=t.extend(this.param,a),this.currentPage=parseInt(i.getHash("page")||1),this.page_size=i.getHash("page_size"),t("[name]",this.search.closest(".form")).each(function(){t(this).val(a[t(this).attr("name")]).trigger("userChange")})},gosearch:function(a){var e=this;if(e.currentPage=a||1,e.search){var s=e.getParam(e.search.closest(".form"));e.param=t.extend(e.param,s)}this.settings.hash?i.setHash(t.extend(e.param,{page:this.currentPage})):e.bind()},getParam:function(t){var a=i.getForm(t);return a},bind:function(){var a=this;if(this.param=t.extend(this.param,{page:this.currentPage,page_size:this.pageSize}),a.table.css("position","relative"),0==a.table.find(".loadingdata").size()){var e=a.table.height()/2-32;e=0>e?32:e,e=30;var i=a.table.width()/2-32;a.table.find("tbody,.tbody").html(""),a.table.nextAll(".sg-pager").find(".nodata").html(""),a.page.hide(),a.table.append('<div class="loadingdata" style="position:absolute;left:'+i+"px;top:"+e+'px;"/>')}a.ajaxData(a.ajaxurl,a.param).done(function(e){if(a.page.show(),a.loading&&a.loading.remove(),t(".loadingdata").remove(),e.status){var i=e.data,s=a.template(i);a.table.html(s),e.data&&(a._total=e.data.count.total||0),a.initPager(),a.callback?a.callback.call(a,e.data,a.table):null}else t.alert(e.msg),a.table.html(e.msg)})},initPager:function(){var t=this,a=t.page;a.data("pagesize")?t.pageSize=a.data("pagesize"):a.data("pagesize",t.pageSize),a.attr("pagesize",t.pageSize),a.parent().prevAll().remove(),0==t._total?(t.table.html('<p class="pdl10 nodata">没有符合条件的数据!</p>'),a.hide()):a.show(),this.pageData?this.pageData.render({count:t._total,pagesize:t.pageSize,current:this.currentPage}):(this.pageData=new e,this.pageData.init({target:this.page,pagesize:t.pageSize,count:t._total,hash:t.settings.hash,callback:function(a){t.currentPage=a,t.settings.hash||t.bind()},current:this.currentPage}))},ajaxData:function(a,e){e=t.extend({},e);var i=t.ajax({type:this.settings.type,url:a,data:e,dataType:"json"});return i}},r});